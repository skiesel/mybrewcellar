{{template "top.html" .}}
<a href="/mycellars">back</a>
<h1>{{ .Cellar.Name }}</h1>

<h2>Add a new beer</h2>

<div id="alert" class="alert" role="alert" {{ if eq .Error "" }} style="display:none;" {{ end }}>{{ .Error }}</div>

{{ with .Cellar }}

<div class="row">
	<div class="col-lg-6">
		<div class="form-horizontal">

			<div class="form-group">
				<label class="col-sm-2 control-label">name:</label>
				<div class="col-sm-10">
					<input class="form-control" type="text" id="newbeer" name="newbeer" />
				</div>
			</div>

			<div class="form-group">
				<label class="col-sm-2 control-label">quantity:</label>
				<div class="col-sm-10">
					<input class="form-control" type="text" readonly id="quantity" name="quantity" />
					<div id="quantity-slider"></div>
				</div>
			</div>


			<div class="form-group">
				<label class="col-sm-2 control-label">notes:</label>
				<div class="col-sm-10">
					<textarea class="form-control" id="notes" name="notes"></textarea>
				</div>
			</div>


			<div class="form-group">
				<label class="col-sm-2 control-label">brewed on:</label>
				<div class="col-sm-10">
					<input class="form-control datepicker" type="text" readonly id="brewed" name="brewed">
				</div>
			</div>


			<div class="form-group">
				<label class="col-sm-2 control-label">added on:</label>
				<div class="col-sm-10">
					<input class="form-control datepicker" type="text" readonly id="added" name="added">
				</div>
			</div>

			<div class="form-group" style="text-align:center;">
					<button id="new-beer" class="btn btn-default">Add</button>
			</div>
			
		</div>
	</div>
</div>

<h2>Existing beers</h2><a id="edit-toggle" href="#">(edit)</a>
<div class="row">
	<div class="col-lg-6">
		<div id="beer-rows" class="list-group">
		  <a id="beer-row-template" class="list-group-item beer-row" style="display:none;">
		    <h3 class="beer-name list-group-item-heading"></h3>	    
		    <div class="row">
		    	<div class="col-lg-6">
		    		<p class="list-group-item-text">Average Rating: 0</p>
				    <p class="list-group-item-text">Quantity: <span class="quantity"></span></p>
		  		</div>
		    	<div class="col-lg-6">
		    		<span class="remove-icon badge pull-right" style="display:none;"><span class="glyphicon glyphicon-trash"></span></span>
		    		<span class="transfer-icon badge pull-right" style="display:none; margin-right:5px;"><span class="glyphicon glyphicon-transfer"></span></span>
	    			<p class="list-group-item-text">Brewed: <span class="brewed"></span></p>
				    <p class="list-group-item-text">Added: <span class="added"></span></p>
				    <p class="list-group-item-text">Age: <span class="age"></span></p>
		  		</div>
		    </div>
		  </a>


			{{ with $Cellar := . }}
			{{ range .Beers }}
		  <a id="Beer{{ .ID }}" href="/beer?cellar={{ $Cellar.ID }}&id={{ .ID }}" data-id="{{.ID}}" data-name="{{.Name}}" class="list-group-item beer-row">
		    
		    <h3 class="beer-name list-group-item-heading">{{ .Name }}</h3>
		    
		    <div class="row">
		    	<div class="col-lg-6">
		    		<p class="list-group-item-text">Average Rating: {{ .GetAverageRating }}</p>
				    <p class="list-group-item-text">Quantity: {{ .Quantity }}</p>
		  		</div>
		    	<div class="col-lg-6">
		    		<span class="remove-icon badge pull-right" style="display:none;"><span class="glyphicon glyphicon-trash"></span></span>
		    		<span class="transfer-icon badge pull-right" style="display:none; margin-right:5px;"><span class="glyphicon glyphicon-transfer"></span></span>
		    		{{ if .Brewed }}
		    			<p class="list-group-item-text">Brewed: {{ .Brewed.ToString }}</p>
		    		{{ end }}
				    <p class="list-group-item-text">Added: {{ .Added.ToString }}</p>
				    <p class="list-group-item-text">Age: {{ .GetAgeString }}</p>
		  		</div>
		    </div>
		  </a>
		  {{ end }}
		  {{ end }}
		</div>
	</div>
</div>
{{ end }}

<a href="#delete-warning" id="delete-warning-link"></a>
<div id="delete-warning" style="display:none;" class="text-center">
	<p>Are you sure you want to delete &quot;<span class="beer-name"></span>&quot;?</p>
	<p>
		<button id="delete-beer" class="btn btn-default">yes</button>
		<button class="btn btn-default cancel">no</button>
	</p>
</div>

<a href="#transfer-warning" id="transfer-warning-link"></a>
<div id="transfer-warning" style="display:none;" class="text-center">
	<p>Where would you like to transfer &quot;<span class="beer-name"></span>&quot;?</p>
	<p>
	<div class="btn-group" data-toggle="buttons" style="padding-bottom:10px;">
		
		{{ with $Page := . }} 
		{{ range .Account.Cellars }}
		  <label class="btn btn-default {{ if eq .Name $Page.Cellar.Name }} default-active active {{ end }}">
		    <input type="radio" name="cellarRadios" data-cellar="{{.ID}}" {{ if eq .Name $Page.Cellar.Name }} checked {{ end }}> {{ .Name }}
		  </label>
		{{ end }}
		{{ end }}
	</div>
	</p>
	<p>
		<button id="transfer-beer" class="btn btn-default">yes</button>
		<button class="btn btn-default cancel">no</button>
	</p>
</div>


<script>
	var cellarID = {{ .Cellar.ID }};
	var selectedBeer = new Object();

	$('.btn').button();

  $(".datepicker").datepicker({
  	"dateFormat": "yy-mm-dd"
  });

	$("#quantity-slider").slider({
		range: "min",
		value: 1,
		min: 1,
		max: 100,
		slide: function( event, ui ) {
			$("#quantity").val(ui.value);
		}
	});
	$("#quantity").val($("#quantity-slider").slider("value"));

	$("#transfer-warning-link").fancybox({
		maxWidth : 500,
		beforeShow : function() { $('.default-active').click(); },

	});
	$('.transfer-icon').click(transferBeer);
	function transferBeer(e) {
		e.preventDefault();
		selectedBeer.id = $(this).closest('.beer-row').data('id');
		selectedBeer.name = $(this).closest('.beer-row').data('name');
		$('#transfer-warning').find('.beer-name').html(selectedBeer.name);
		$("#transfer-warning-link").click();		
	}

	$("#delete-warning-link").fancybox();

	$('#edit-toggle').click(function(e) {
		if($('#edit-toggle').html() === "(edit)") {
			$('#edit-toggle').html("(disable edit)")
			$('.badge').show();
		}
		else {
			$('#edit-toggle').html("(edit)")
			$('.badge').hide();
		}
		e.preventDefault();
	});

	$('.remove-icon').click(removeBeer);
	function removeBeer(e) {
		e.preventDefault();
		selectedBeer.id = $(this).closest('.beer-row').data('id');
		selectedBeer.name = $(this).closest('.beer-row').data('name');
		$('#delete-warning').find('.beer-name').html(selectedBeer.name);
		$("#delete-warning-link").click();		
	}

	$('#delete-beer').click(function() {
		$.fancybox.close();
		$.ajax({
			type : "POST",
			url : "api/delete-beer",
			context : $(this),
			data : { 
				cellarID : cellarID,
				beerID : selectedBeer.id
			},
			success : function(data) {
				var obj = $.parseJSON(data);
				if(obj.Status == "SUCCESS") {
					$('#Beer'+obj.Data.ID).remove();
					showError("Beer successfully deleted : &quot;" + obj.Data.Name + "&quot;", SUCCESS);
				}
				else {
					showError("Failed to delete beer : (" + obj.Error + ")");
				}
			}
		});
	});

	$('#transfer-beer').click(function() {
		console.log({ 
				fromCellarID : cellarID,
				toCellarID : $('input[name=cellarRadios]:checked').data('cellar'),
				beerID : selectedBeer.id,
			});
		$.fancybox.close();
		$.ajax({
			type : "POST",
			url : "api/transfer-beer",
			context : $(this),
			data : { 
				fromCellarID : cellarID,
				toCellarID : $('input[name=cellarRadios]:checked').data('cellar'),
				beerID : selectedBeer.id,
			},
			success : function(data) {
				var obj = $.parseJSON(data);
				if(obj.Status == "SUCCESS") {
					$('#Beer'+obj.Data.Beer.ID).remove();
					showError("&quot;"
						+ obj.Data.Beer.Name
						+ "&quot; successfully transferred from &quot;"
						+ obj.Data.FromCellar.Name
						+ "&quot;"
						+ " to &quot;"
						+ obj.Data.ToCellar.Name
						+ "&quot;", SUCCESS);
				}
				else {
					showError("Failed to transfer beer : (" + obj.Error + ")");
				}
			}
		});
	});

	$('.cancel').click(function() {	
		$.fancybox.close();
	});

	$('#new-beer').click(function() {
		$.ajax({
			type : "POST",
			url : "api/new-beer",
			context : $(this),
			data : {
				cellarID : cellarID,
				name : $('#newbeer').val(),
				quantity : $('#quantity').val(),
				notes : $('#notes').val(),
				brewed : $('#brewed').val(), 
				added : $('#added').val(),
			},
			success : function(data) {
				var obj = $.parseJSON(data);

				console.log(obj);

				if(obj.Status == "SUCCESS") {
					var newBeer = $("#beer-row-template").clone().css("display", "block");
					newBeer.attr("href", "/beer?cellar="+cellarID+"&beer="+obj.Data.ID);
					newBeer.attr("id", "Beer"+obj.Data.ID);
					$(newBeer).data("id", obj.Data.ID);
					$(newBeer).data("name", obj.Data.Name);
					$(newBeer).find(".beer-name").html(obj.Data.Name);
					$(newBeer).find(".quantity").html(obj.Data.Quantity);
					$(newBeer).find(".brewed").html(obj.Data.Brewed);
					$(newBeer).find(".added").html(obj.Data.Added);
					$(newBeer).find(".age").html(obj.Data.Age);
					$(newBeer).find('.remove-icon').click(removeBeer);
					$(newBeer).find('.transfer-icon').click(transferBeer);
					$(newBeer).find('.btn').button();
					$('#beer-rows').append(newBeer);
					showError("Successfully added new beer : &quot;" + obj.Data.Name + "&quot;", SUCCESS);
				}
				else {
					showError("Failed to add beer (" + obj.Error + ")");
				}
			}
		});
	});

</script>

{{template "bottom.html" .}}